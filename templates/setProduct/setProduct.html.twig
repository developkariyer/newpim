{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-section {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
        }
        
        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-item:hover {
            background: #f5f5f5;
        }
        
        .selected-product {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block title %}Set Ürün Oluştur{% endblock %}

{% block content %}
    <div class="container">
        <h1>Set Ürün Oluştur</h1>
        
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}" style="padding: 10px; margin: 10px 0; border-radius: 4px; background: {% if label == 'success' %}#d4edda{% else %}#f8d7da{% endif %};">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <!-- Ana Ürün Seçimi -->
        <div class="form-section">
            <h3>Ana Ürün Seç</h3>
            <div style="position: relative;">
                <input type="text" 
                       id="productSearch" 
                       class="form-control" 
                       placeholder="Ürün ara..."
                       autocomplete="off">
                <div id="productResults" class="search-results" style="display: none;"></div>
            </div>
            
            <div id="selectedProduct" style="display: none;">
                <div class="selected-product">
                    <h5>Seçilen Ürün:</h5>
                    <div id="productInfo"></div>
                    <button type="button" onclick="clearProduct()" class="btn btn-primary">Temizle</button>
                </div>
            </div>
        </div>

        <!-- İwasku Ürünleri -->
        <div class="form-section">
            <h3>İwasku Ürünleri Ekle</h3>
            <div style="position: relative;">
                <input type="text" 
                       id="iwaskuSearch" 
                       class="form-control" 
                       placeholder="İwasku ara..."
                       autocomplete="off">
                <div id="iwaskuResults" class="search-results" style="display: none;"></div>
            </div>
            
            <div id="selectedIwasku">
                <h5>Seçilen İwasku Ürünleri:</h5>
                <div id="iwaskuList">Henüz ürün seçilmedi</div>
            </div>
        </div>

        <!-- Form -->
        <form id="setForm" method="POST" action="{{ path('set_product_create') }}">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" id="productId" name="selectedProductId" value="">
            <input type="hidden" id="iwaskuData" name="iwaskuItems" value="">
            
            <button type="submit" id="submitBtn" class="btn btn-success" disabled>
                Set Ürün Oluştur
            </button>
        </form>
    </div>

    <script>
        console.log('JavaScript yüklendi!');
        
        let selectedProduct = null;
        let selectedIwasku = [];
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM yüklendi!');
            
            // Ana ürün arama
            document.getElementById('productSearch').addEventListener('input', function(e) {
                console.log('Ürün arama:', e.target.value);
                searchProducts(e.target.value);
            });
            
            // İwasku arama
            document.getElementById('iwaskuSearch').addEventListener('input', function(e) {
                console.log('İwasku arama:', e.target.value);
                searchIwasku(e.target.value);
            });
        });
        
        function searchProducts(query) {
            console.log('searchProducts çağrıldı:', query);
            
            if (query.length < 2) {
                document.getElementById('productResults').style.display = 'none';
                return;
            }
            
            fetch('{{ path('set_product_search_products') }}?q=' + encodeURIComponent(query))
                .then(response => {
                    console.log('Response alındı:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('Data:', data);
                    showProductResults(data.items || []);
                })
                .catch(error => {
                    console.error('Hata:', error);
                });
        }
        
        function showProductResults(products) {
            console.log('showProductResults:', products);
            
            const container = document.getElementById('productResults');
            
            if (products.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = '';
            products.forEach(product => {
                html += `
                    <div class="search-item" onclick="selectProduct(${product.id}, '${product.name}', '${product.iwasku}', '${product.identifier}')">
                        <strong>${product.iwasku}</strong> - ${product.name}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
        }
        
        function selectProduct(id, name, iwasku, identifier) {
            console.log('Ürün seçildi:', id, name, iwasku);
            
            selectedProduct = { id, name, iwasku, identifier };
            
            document.getElementById('productSearch').value = iwasku + ' - ' + name;
            document.getElementById('productId').value = id;
            document.getElementById('productResults').style.display = 'none';
            
            document.getElementById('productInfo').innerHTML = `
                <p><strong>İwasku:</strong> ${iwasku}</p>
                <p><strong>İsim:</strong> ${name}</p>
            `;
            
            document.getElementById('selectedProduct').style.display = 'block';
            updateSubmitButton();
        }
        
        function clearProduct() {
            selectedProduct = null;
            document.getElementById('productSearch').value = '';
            document.getElementById('productId').value = '';
            document.getElementById('selectedProduct').style.display = 'none';
            updateSubmitButton();
        }
        
        function searchIwasku(query) {
            console.log('searchIwasku çağrıldı:', query);
            
            if (query.length < 2) {
                document.getElementById('iwaskuResults').style.display = 'none';
                return;
            }
            
            fetch('{{ path('set_product_search_iwasku') }}?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    console.log('İwasku data:', data);
                    showIwaskuResults(data.items || []);
                })
                .catch(error => {
                    console.error('İwasku hata:', error);
                });
        }
        
        function showIwaskuResults(products) {
            const container = document.getElementById('iwaskuResults');
            
            if (products.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = '';
            products.forEach(product => {
                html += `
                    <div class="search-item" onclick="addIwasku(${product.id}, '${product.name}', '${product.iwasku}')">
                        <strong>${product.iwasku}</strong> - ${product.name}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
        }
        
        function addIwasku(id, name, iwasku) {
            console.log('İwasku eklendi:', id, name, iwasku);
            
            // Zaten var mı kontrol et
            if (selectedIwasku.find(item => item.id === id)) {
                alert('Bu ürün zaten eklenmiş!');
                return;
            }
            
            selectedIwasku.push({ id, name, iwasku, quantity: 1 });
            
            document.getElementById('iwaskuSearch').value = '';
            document.getElementById('iwaskuResults').style.display = 'none';
            
            updateIwaskuList();
            updateSubmitButton();
        }
        
        function updateIwaskuList() {
            const container = document.getElementById('iwaskuList');
            
            if (selectedIwasku.length === 0) {
                container.innerHTML = 'Henüz ürün seçilmedi';
                return;
            }
            
            let html = '';
            selectedIwasku.forEach((item, index) => {
                html += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">
                        <strong>${item.iwasku}</strong> - ${item.name}
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="updateQuantity(${index}, this.value)"
                               style="width: 60px; margin-left: 10px;">
                        <button type="button" onclick="removeIwasku(${index})" 
                                style="margin-left: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px;">
                            Kaldır
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('iwaskuData').value = JSON.stringify(selectedIwasku);
        }
        
        function updateQuantity(index, quantity) {
            selectedIwasku[index].quantity = parseInt(quantity) || 1;
            document.getElementById('iwaskuData').value = JSON.stringify(selectedIwasku);
        }
        
        function removeIwasku(index) {
            selectedIwasku.splice(index, 1);
            updateIwaskuList();
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = !selectedProduct || selectedIwasku.length === 0;
        }
        
        // Form submit
        document.getElementById('setForm').addEventListener('submit', function(e) {
            if (!selectedProduct) {
                e.preventDefault();
                alert('Ana ürün seçin!');
                return;
            }
            
            if (selectedIwasku.length === 0) {
                e.preventDefault();
                alert('İwasku ürünleri ekleyin!');
                return;
            }
            
            document.getElementById('iwaskuData').value = JSON.stringify(selectedIwasku);
        });
        
        // Dış tıklama ile sonuçları gizle
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#productSearch') && !e.target.closest('#productResults')) {
                document.getElementById('productResults').style.display = 'none';
            }
            if (!e.target.closest('#iwaskuSearch') && !e.target.closest('#iwaskuResults')) {
                document.getElementById('iwaskuResults').style.display = 'none';
            }
        });
    </script>
{% endblock %}