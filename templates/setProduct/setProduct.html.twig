{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('assets/css/product.css') }}" rel="stylesheet">
    <style>
        .set-product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .form-section {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-section h3 {
            margin: 0 0 1.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: 600;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .selected-product {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .iwasku-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .iwasku-item-info {
            flex: 1;
        }
        
        .iwasku-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 1rem;
        }
        
        .quantity-input {
            width: 80px;
            text-align: center;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 2px dashed #dee2e6;
        }
    </style>
{% endblock %}

{% block title %}Set √úr√ºn Olu≈ütur{% endblock %}

{% block content %}
    <div class="set-product-container">
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'danger' ? 'danger' : (label == 'success' ? 'success' : 'info') }}" style="margin-bottom: 1rem;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <form id="setProductForm" method="POST" action="{{ path('set_product_create') }}">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" id="selectedProductId" name="selectedProductId" value="">
            <input type="hidden" id="iwaskuItemsData" name="iwaskuItems" value="">

            <!-- Ana √úr√ºn Se√ßimi -->
            <div class="form-section">
                <h3>üîç Ana √úr√ºn Se√ß</h3>
                <div class="search-container">
                    <label for="productSearch">√úr√ºn Ara (Identifier veya ƒ∞sim)</label>
                    <input type="text" 
                           id="productSearch" 
                           class="form-control" 
                           placeholder="√ñrn: PTS-001 veya Premium Cotton T-Shirt"
                           autocomplete="off">
                    <div id="productSearchResults" class="search-results" style="display: none;"></div>
                </div>
                
                <div id="selectedProductInfo" style="display: none;">
                    <div class="selected-product">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1976d2;">‚úÖ Se√ßilen √úr√ºn:</h5>
                        <div id="selectedProductDetails"></div>
                        <button type="button" id="clearSelectedProduct" class="btn btn-outline-secondary btn-sm" style="margin-top: 0.5rem;">
                            ‚ùå Se√ßimi Temizle
                        </button>
                    </div>
                </div>
            </div>

            <!-- ƒ∞wasku √úr√ºnleri Se√ßimi -->
            <div class="form-section">
                <h3>üì¶ ƒ∞wasku √úr√ºnleri Ekle</h3>
                <div class="search-container">
                    <label for="iwaskuSearch">ƒ∞wasku √úr√ºn Ara</label>
                    <input type="text" 
                           id="iwaskuSearch" 
                           class="form-control" 
                           placeholder="ƒ∞wasku kodu veya √ºr√ºn adƒ± ile ara..."
                           autocomplete="off">
                    <div id="iwaskuSearchResults" class="search-results" style="display: none;"></div>
                </div>

                <div id="selectedIwaskuContainer">
                    <h5 style="margin: 1.5rem 0 1rem 0;">Se√ßilen ƒ∞wasku √úr√ºnleri:</h5>
                    <div id="selectedIwaskuList">
                        <div class="empty-state">
                            <p style="margin: 0; font-size: 1.1rem;">üì≠ Hen√ºz ƒ∞wasku √ºr√ºn√º se√ßilmedi</p>
                            <small>Yukarƒ±daki arama kutusunu kullanarak ƒ∞wasku √ºr√ºnleri ekleyin</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Butonu -->
            <div style="text-align: right; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='{{ path('product') }}'">
                    ƒ∞ptal
                </button>
                <button type="submit" id="submitBtn" class="btn btn-success" disabled>
                    üéØ Set √úr√ºn Olu≈ütur
                </button>
            </div>
        </form>
    </div>
{% endblock %}

{% block body_scripts %}
    {{ parent() }}
    <script>
        window.setProductConfig = {
            csrfToken: '{{ csrf_token }}',
            endpoints: {
                searchProducts: '{{ path('set_product_search_products') }}',
                searchIwasku: '{{ path('set_product_search_iwasku') }}'
            }
        };

        // Set Product functionality
        const SetProduct = {
            selectedProduct: null,
            selectedIwasku: [],

            init() {
                this.bindEvents();
            },

            bindEvents() {
                // Ana √ºr√ºn arama
                document.getElementById('productSearch').addEventListener('input', this.handleProductSearch.bind(this));
                document.getElementById('clearSelectedProduct').addEventListener('click', this.clearSelectedProduct.bind(this));
                
                // ƒ∞wasku arama
                document.getElementById('iwaskuSearch').addEventListener('input', this.handleIwaskuSearch.bind(this));
                
                // Form submit
                document.getElementById('setProductForm').addEventListener('submit', this.handleSubmit.bind(this));
                
                // Dƒ±≈ü tƒ±klama ile sonu√ßlarƒ± gizle
                document.addEventListener('click', this.handleOutsideClick.bind(this));
            },

            handleProductSearch(e) {
                const query = e.target.value.trim();
                const resultsContainer = document.getElementById('productSearchResults');
                
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                fetch(`${window.setProductConfig.endpoints.searchProducts}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        this.displayProductResults(data.items || []);
                    })
                    .catch(error => {
                        console.error('√úr√ºn arama hatasƒ±:', error);
                        resultsContainer.style.display = 'none';
                    });
            },

            displayProductResults(products) {
                const resultsContainer = document.getElementById('productSearchResults');
                
                if (products.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                const html = products.map(product => `
                    <div class="search-result-item" onclick="SetProduct.selectProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.identifier}', '${(product.description || '').replace(/'/g, "\\'")}')">
                        <strong>${product.identifier}</strong> - ${product.name}
                        ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                    </div>
                `).join('');

                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';
            },

            selectProduct(id, name, identifier, description) {
                this.selectedProduct = { id, name, identifier, description };
                
                document.getElementById('productSearch').value = `${identifier} - ${name}`;
                document.getElementById('selectedProductId').value = id;
                document.getElementById('productSearchResults').style.display = 'none';
                
                const detailsHtml = `
                    <p><strong>ID:</strong> ${id}</p>
                    <p><strong>Identifier:</strong> ${identifier}</p>
                    <p><strong>ƒ∞sim:</strong> ${name}</p>
                    ${description ? `<p><strong>A√ßƒ±klama:</strong> ${description}</p>` : ''}
                `;
                
                document.getElementById('selectedProductDetails').innerHTML = detailsHtml;
                document.getElementById('selectedProductInfo').style.display = 'block';
                
                this.updateSubmitButton();
            },

            clearSelectedProduct() {
                this.selectedProduct = null;
                document.getElementById('productSearch').value = '';
                document.getElementById('selectedProductId').value = '';
                document.getElementById('selectedProductInfo').style.display = 'none';
                this.updateSubmitButton();
            },

            handleIwaskuSearch(e) {
                const query = e.target.value.trim();
                const resultsContainer = document.getElementById('iwaskuSearchResults');
                
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                fetch(`${window.setProductConfig.endpoints.searchIwasku}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        this.displayIwaskuResults(data.items || []);
                    })
                    .catch(error => {
                        console.error('ƒ∞wasku arama hatasƒ±:', error);
                        resultsContainer.style.display = 'none';
                    });
            },

            displayIwaskuResults(products) {
                const resultsContainer = document.getElementById('iwaskuSearchResults');
                
                if (products.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                const html = products.map(product => `
                    <div class="search-result-item" onclick="SetProduct.addIwaskuProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.iwasku}', '${product.identifier}')">
                        <strong>${product.iwasku}</strong> - ${product.name}
                        <br><small class="text-muted">ID: ${product.identifier}</small>
                    </div>
                `).join('');

                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';
            },

            addIwaskuProduct(id, name, iwasku, identifier) {
                // Zaten eklenmi≈ü mi kontrol et
                if (this.selectedIwasku.find(item => item.id === id)) {
                    alert('Bu √ºr√ºn zaten eklenmi≈ü!');
                    return;
                }

                const iwaskuItem = { id, name, iwasku, identifier, quantity: 1 };
                this.selectedIwasku.push(iwaskuItem);
                
                document.getElementById('iwaskuSearch').value = '';
                document.getElementById('iwaskuSearchResults').style.display = 'none';
                
                this.updateIwaskuList();
                this.updateSubmitButton();
            },

            updateIwaskuList() {
                const container = document.getElementById('selectedIwaskuList');
                
                if (this.selectedIwasku.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p style="margin: 0; font-size: 1.1rem;">üì≠ Hen√ºz ƒ∞wasku √ºr√ºn√º se√ßilmedi</p>
                            <small>Yukarƒ±daki arama kutusunu kullanarak ƒ∞wasku √ºr√ºnleri ekleyin</small>
                        </div>
                    `;
                    return;
                }

                const html = this.selectedIwasku.map((item, index) => `
                    <div class="iwasku-item">
                        <div class="iwasku-item-info">
                            <strong>${item.iwasku}</strong> - ${item.name}
                            <br><small class="text-muted">ID: ${item.identifier}</small>
                        </div>
                        <div class="iwasku-item-quantity">
                            <label>Adet:</label>
                            <input type="number" 
                                   class="form-control quantity-input" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   onchange="SetProduct.updateQuantity(${index}, this.value)">
                        </div>
                        <button type="button" class="btn-remove" onclick="SetProduct.removeIwaskuProduct(${index})">
                            üóëÔ∏è Kaldƒ±r
                        </button>
                    </div>
                `).join('');

                container.innerHTML = html;
                
                // Hidden input'u g√ºncelle
                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            updateQuantity(index, quantity) {
                if (quantity < 1) quantity = 1;
                this.selectedIwasku[index].quantity = parseInt(quantity);
                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            removeIwaskuProduct(index) {
                this.selectedIwasku.splice(index, 1);
                this.updateIwaskuList();
                this.updateSubmitButton();
            },

            updateSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                const canSubmit = this.selectedProduct && this.selectedIwasku.length > 0;
                submitBtn.disabled = !canSubmit;
            },

            handleSubmit(e) {
                if (!this.selectedProduct) {
                    e.preventDefault();
                    alert('L√ºtfen bir ana √ºr√ºn se√ßin!');
                    return;
                }

                if (this.selectedIwasku.length === 0) {
                    e.preventDefault();
                    alert('L√ºtfen en az bir ƒ∞wasku √ºr√ºn√º ekleyin!');
                    return;
                }

                // Form verilerini g√ºncelle
                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            handleOutsideClick(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('productSearchResults').style.display = 'none';
                    document.getElementById('iwaskuSearchResults').style.display = 'none';
                }
            }
        };

        // Sayfa y√ºklendiƒüinde ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            SetProduct.init();
        });
    </script>
{% endblock %}