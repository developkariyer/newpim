{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('assets/css/product.css') }}" rel="stylesheet">
{% endblock %}

{% block title %}Set √úr√ºn Olu≈ütur{% endblock %}

{% block content %}
    <div class="product-form-container">
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'danger' ? 'danger' : (label == 'success' ? 'success' : 'info') }}" style="margin-bottom: 1rem;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <form id="setProductForm" method="POST" action="{{ path('set_product_create') }}">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" id="selectedProductId" name="selectedProductId" value="">
            <input type="hidden" id="iwaskuItemsData" name="iwaskuItems" value="">

            <!-- Ana √úr√ºn Se√ßimi -->
            <div class="form-section" style="background: #f8f9fa; border-color: #17a2b8;">
                <h3 style="border-color: #17a2b8; color: #17a2b8;">üîç Ana √úr√ºn Se√ß</h3>
                <div class="form-group" style="position: relative;">
                    <label for="productSearch">√úr√ºn Ara (ƒ∞wasku veya ƒ∞sim)</label>
                    <input type="text" 
                           id="productSearch" 
                           class="form-control" 
                           placeholder="√ñrn: IW-001 veya Premium Cotton T-Shirt"
                           autocomplete="off">
                    <div id="productSearchResults" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; background: white; border-radius: 4px; margin-top: 2px;"></div>
                </div>
                
                <div id="selectedProductInfo" style="display: none; padding: 1rem; background: #e3f2fd; border-radius: 4px; margin-top: 1rem;">
                    <h5 style="margin: 0 0 0.5rem 0; color: #1976d2;">‚úÖ Se√ßilen √úr√ºn:</h5>
                    <div id="selectedProductDetails"></div>
                    <button type="button" id="clearSelectedProduct" class="btn btn-outline-secondary btn-sm" style="margin-top: 0.5rem;">‚ùå Se√ßimi Temizle</button>
                </div>
            </div>

            <!-- ƒ∞wasku √úr√ºnleri Se√ßimi -->
            <div class="form-section">
                <h3>üì¶ ƒ∞wasku √úr√ºnleri Ekle</h3>
                <div class="form-group" style="position: relative;">
                    <label for="iwaskuSearch">ƒ∞wasku √úr√ºn Ara</label>
                    <input type="text" 
                           id="iwaskuSearch" 
                           class="form-control" 
                           placeholder="ƒ∞wasku kodu veya √ºr√ºn adƒ± ile ara..."
                           autocomplete="off">
                    <div id="iwaskuSearchResults" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; background: white; border-radius: 4px; margin-top: 2px;"></div>
                </div>

                <div id="selectedIwaskuContainer" style="margin-top: 1rem;">
                    <h5>Se√ßilen ƒ∞wasku √úr√ºnleri:</h5>
                    <div id="selectedIwaskuList" style="min-height: 50px; border: 2px dashed #dee2e6; border-radius: 4px; padding: 1rem; background: #f8f9fa;">
                        <small style="color: #6c757d;">Hen√ºz ƒ∞wasku √ºr√ºn√º se√ßilmedi</small>
                    </div>
                </div>
            </div>

            <!-- Submit Butonu -->
            <div style="text-align: right; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='{{ path('product') }}'">
                    ƒ∞ptal
                </button>
                <button type="submit" id="submitBtn" class="btn btn-success" disabled>
                    üéØ Set √úr√ºn Olu≈ütur
                </button>
            </div>
        </form>
    </div>
{% endblock %}

{% block body_scripts %}
    {{ parent() }}
    <script>
        window.setProductConfig = {
            csrfToken: '{{ csrf_token }}',
            endpoints: {
                searchProducts: '{{ path('set_product_search_products') }}',
                searchIwasku: '{{ path('set_product_search_iwasku') }}'
            }
        };

        const SetProduct = {
            selectedProduct: null,
            selectedIwasku: [],

            init() {
                this.bindEvents();
            },

            bindEvents() {
                // Ana √ºr√ºn arama - ProductController'daki gibi
                document.getElementById('productSearch').addEventListener('input', (e) => {
                    this.handleSearch(e.target.value, 'product');
                });
                
                // ƒ∞wasku arama
                document.getElementById('iwaskuSearch').addEventListener('input', (e) => {
                    this.handleSearch(e.target.value, 'iwasku');
                });

                // Temizle butonu
                document.getElementById('clearSelectedProduct').addEventListener('click', () => {
                    this.clearSelectedProduct();
                });

                // Form submit
                document.getElementById('setProductForm').addEventListener('submit', (e) => {
                    this.handleSubmit(e);
                });

                // Dƒ±≈ü tƒ±klama ile sonu√ßlarƒ± gizle
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#productSearch') && !e.target.closest('#productSearchResults')) {
                        document.getElementById('productSearchResults').style.display = 'none';
                    }
                    if (!e.target.closest('#iwaskuSearch') && !e.target.closest('#iwaskuSearchResults')) {
                        document.getElementById('iwaskuSearchResults').style.display = 'none';
                    }
                });
            },

            handleSearch(query, type) {
                if (query.length < 2) {
                    document.getElementById(type + 'SearchResults').style.display = 'none';
                    return;
                }

                const endpoint = type === 'product' ? 
                    window.setProductConfig.endpoints.searchProducts : 
                    window.setProductConfig.endpoints.searchIwasku;

                fetch(`${endpoint}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        this.displayResults(data.items || [], type);
                    })
                    .catch(error => {
                        console.error('Arama hatasƒ±:', error);
                    });
            },

            displayResults(items, type) {
                const container = document.getElementById(type + 'SearchResults');
                
                if (items.length === 0) {
                    container.innerHTML = '<div style="padding: 0.75rem; color: #6c757d;">√úr√ºn bulunamadƒ±</div>';
                    container.style.display = 'block';
                    return;
                }

                const html = items.map(item => {
                    const displayText = `${item.iwasku || item.identifier} - ${item.name}`;
                    const clickHandler = type === 'product' ? 
                        `SetProduct.selectProduct(${item.id}, '${this.escapeQuotes(item.name)}', '${item.identifier}', '${item.iwasku || ''}', '${this.escapeQuotes(item.description || '')}')` :
                        `SetProduct.addIwaskuProduct(${item.id}, '${this.escapeQuotes(item.name)}', '${item.iwasku}', '${item.identifier}')`;
                        
                    return `
                        <div style="padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer;" 
                             onclick="${clickHandler}"
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'">
                            <strong>${displayText}</strong>
                            ${item.description ? `<br><small style="color: #6c757d;">${item.description}</small>` : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                container.style.display = 'block';
            },

            selectProduct(id, name, identifier, iwasku, description) {
                this.selectedProduct = { id, name, identifier, iwasku, description };
                
                document.getElementById('productSearch').value = `${iwasku || identifier} - ${name}`;
                document.getElementById('selectedProductId').value = id;
                document.getElementById('productSearchResults').style.display = 'none';
                
                const detailsHtml = `
                    <p><strong>ID:</strong> ${id}</p>
                    <p><strong>ƒ∞wasku:</strong> ${iwasku || 'Yok'}</p>
                    <p><strong>Identifier:</strong> ${identifier}</p>
                    <p><strong>ƒ∞sim:</strong> ${name}</p>
                    ${description ? `<p><strong>A√ßƒ±klama:</strong> ${description}</p>` : ''}
                `;
                
                document.getElementById('selectedProductDetails').innerHTML = detailsHtml;
                document.getElementById('selectedProductInfo').style.display = 'block';
                
                this.updateSubmitButton();
            },

            clearSelectedProduct() {
                this.selectedProduct = null;
                document.getElementById('productSearch').value = '';
                document.getElementById('selectedProductId').value = '';
                document.getElementById('selectedProductInfo').style.display = 'none';
                this.updateSubmitButton();
            },

            addIwaskuProduct(id, name, iwasku, identifier) {
                // Zaten eklenmi≈ü mi kontrol et
                if (this.selectedIwasku.find(item => item.id === id)) {
                    alert('Bu √ºr√ºn zaten eklenmi≈ü!');
                    return;
                }

                const iwaskuItem = { id, name, iwasku, identifier, quantity: 1 };
                this.selectedIwasku.push(iwaskuItem);
                
                document.getElementById('iwaskuSearch').value = '';
                document.getElementById('iwaskuSearchResults').style.display = 'none';
                
                this.updateIwaskuList();
                this.updateSubmitButton();
            },

            updateIwaskuList() {
                const container = document.getElementById('selectedIwaskuList');
                
                if (this.selectedIwasku.length === 0) {
                    container.innerHTML = '<small style="color: #6c757d;">Hen√ºz ƒ∞wasku √ºr√ºn√º se√ßilmedi</small>';
                    return;
                }

                const html = this.selectedIwasku.map((item, index) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>${item.iwasku}</strong> - ${item.name}
                            <br><small style="color: #6c757d;">ID: ${item.identifier}</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label>Adet:</label>
                            <input type="number" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   style="width: 60px; text-align: center; padding: 0.25rem;"
                                   onchange="SetProduct.updateQuantity(${index}, this.value)">
                            <button type="button" 
                                    onclick="SetProduct.removeIwaskuProduct(${index})"
                                    style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            updateQuantity(index, quantity) {
                if (quantity < 1) quantity = 1;
                this.selectedIwasku[index].quantity = parseInt(quantity);
                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            removeIwaskuProduct(index) {
                this.selectedIwasku.splice(index, 1);
                this.updateIwaskuList();
                this.updateSubmitButton();
            },

            updateSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                const canSubmit = this.selectedProduct && this.selectedIwasku.length > 0;
                submitBtn.disabled = !canSubmit;
            },

            handleSubmit(e) {
                if (!this.selectedProduct) {
                    e.preventDefault();
                    alert('L√ºtfen bir ana √ºr√ºn se√ßin!');
                    return;
                }

                if (this.selectedIwasku.length === 0) {
                    e.preventDefault();
                    alert('L√ºtfen en az bir ƒ∞wasku √ºr√ºn√º ekleyin!');
                    return;
                }

                document.getElementById('iwaskuItemsData').value = JSON.stringify(this.selectedIwasku);
            },

            escapeQuotes(str) {
                return str ? str.replace(/'/g, "\\'") : '';
            }
        };

        // Sayfa y√ºklendiƒüinde ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            SetProduct.init();
        });
    </script>
{% endblock %}